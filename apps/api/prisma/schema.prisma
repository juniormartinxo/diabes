generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  extensions = [vector]
}

model Document {
  id           String   @id @default(uuid())
  url          String   @unique
  title        String?
  contentClean String?  @db.Text
  contentHash  String?
  version      Int      @default(1)
  crawledAt    DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  chunks       Chunk[]

  @@map("documents")
}

model Chunk {
  id         String   @id @default(uuid())
  documentId String
  heading    String?
  chunkText  String   @db.Text
  // Generated column in SQL for full-text search (see migration)
  tsv        Unsupported("tsvector")?
  chunkHash  String   @unique
  tokenCount Int?
  position   Int?
  createdAt  DateTime @default(now())

  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  embedding  ChunkEmbedding?

  @@map("chunks")
}

model ChunkEmbedding {
  chunkId   String   @id
  // Usando Unsupported para tipo vector. Definindo 1536 dim (OpenAI)
  embedding Unsupported("vector(1536)")
  model     String   @default("text-embedding-ada-002")
  createdAt DateTime @default(now())

  chunk     Chunk    @relation(fields: [chunkId], references: [id], onDelete: Cascade)

  @@map("chunk_embeddings")
}

model CrawlRun {
  id        String   @id @default(uuid())
  status    String   // PENDING, RUNNING, COMPLETED, FAILED
  startedAt DateTime @default(now())
  endedAt   DateTime?
  stats     Json?
  createdAt DateTime @default(now())

  @@map("crawl_runs")
}

model QALog {
  id          String   @id @default(uuid())
  question    String
  topChunks   Json     // Array of chunk IDs or snippets
  answer      String?  @db.Text
  safetyFlags String[]
  createdAt   DateTime @default(now())

  @@map("qalogs")
}
